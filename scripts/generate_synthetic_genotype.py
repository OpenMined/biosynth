#!/usr/bin/env python3
"""
Generate a genotype file from reference lookup data.
"""

from __future__ import annotations

import argparse
import csv
import random
from pathlib import Path
from typing import Iterable, List, Tuple

HEADER_TEXT = """# This data file generated by Dynamic DNA (DDNA) Laboratories at: Thu Nov 7 16:03:14 2024
#						
# This file contains raw genetic data, including data that is not used in DDNA reports. 						
# This data has undergone a general quality review however only a subset of markers have been 						
# individually reviewed for accuracy. As such, this data is suitable only for research,  						
# educational, and informational use and not for any medical or diagnostic use. 						
# 						
# Below is a text version of your data.  Fields are TAB-separated and						
# each line corresponds to a single SNP.  For each SNP, we provide its identifier,  						
# it chromosomal location realtive to Build 38 of the human reference genome, and the 						
# genotype call oriented with respect to the plus strand on the human reference sequence.						
# More information about Dynamic DNA Laboratories can be found at:						
# https://dynamicdnalabs.com						
# 						
# More information on reference human assembly builds:						
# https://www.ncbi.nlm.nih.gov/datasets/genome/GCF_000001405.40/						
#						
# rsid	chromosome	position	genotype	gs	baf	lrr
"""


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description="Generate a genotype file from lookup CSV data."
    )
    parser.add_argument(
        "--lookup",
        type=Path,
        help="CSV produced by extract_reference_variants.py containing exact matches",
    )
    parser.add_argument(
        "--output",
        type=Path,
        help="Destination path for the synthetic genotype file",
    )
    parser.add_argument(
        "--alt-frequency",
        type=float,
        default=0.01,
        help="Probability of using a random ALT allele instead of the reference",
    )
    parser.add_argument(
        "--seed",
        type=int,
        default=None,
        help="Optional RNG seed for reproducible output",
    )
    return parser.parse_args()


def iter_lookup_rows(path: Path) -> Iterable[Tuple[str, str, str, str, List[str]]]:
    with path.open() as handle:
        reader = csv.DictReader(handle)
        for row in reader:
            if row.get("status") != "exact":
                continue
            rsid = row["query_rsid"]
            chrom = row["query_chrom"]
            pos = row["query_pos"]
            ref = (row.get("ref") or "").strip()
            alts = [
                allele.strip()
                for allele in (row.get("alt") or "").split(",")
                if allele.strip()
            ]
            if not ref:
                continue
            yield rsid, chrom, pos, ref, alts


def classify_variant(ref: str, alts: List[str]) -> str:
    if not alts:
        return "snp"
    ref_len = len(ref)
    if ref_len == 1 and all(len(alt) == 1 for alt in alts):
        return "snp"
    if all(len(alt) == ref_len for alt in alts) and ref_len > 1:
        return "mnv"
    first_alt_len = len(alts[0])
    if first_alt_len > ref_len:
        return "insertion"
    if first_alt_len < ref_len:
        return "deletion"
    return "mnv"


def synthesize_genotype(ref: str, alts: List[str], alt_frequency: float) -> str:
    kind = classify_variant(ref, alts)
    use_alt = bool(alts) and random.random() < alt_frequency

    if kind in {"snp", "mnv"}:
        allele = ref
        if use_alt:
            allele = random.choice(alts) or ref
        symbol = allele if kind == "snp" else (allele[0] if allele else "?")
        return f"{symbol}{symbol}"

    if kind == "insertion":
        symbol = "I" if use_alt else "D"
        return f"{symbol}{symbol}"

    if kind == "deletion":
        symbol = "D" if use_alt else "I"
        return f"{symbol}{symbol}"

    # Fallback
    symbol = ref[0] if ref else "?"
    return f"{symbol}{symbol}"


def write_output(
    path: Path, rows: Iterable[Tuple[str, str, str, str, List[str]]], alt_freq: float
) -> int:
    path.parent.mkdir(parents=True, exist_ok=True)
    written = 0
    with path.open("w") as handle:
        handle.write(HEADER_TEXT)
        for rsid, chrom, pos, ref, alts in rows:
            genotype = synthesize_genotype(ref, alts, alt_freq)
            # Fill placeholder numeric columns with plausible floats.
            gs = f"{random.uniform(0.2, 1.0):.4f}"
            baf = f"{random.uniform(0.0, 1.0):.3f}"
            lrr = f"{random.uniform(-0.5, 0.5):.4f}"
            line = "\t".join([rsid, chrom, pos, genotype, gs, baf, lrr])
            handle.write(line + "\n")
            written += 1
    return written


def main() -> None:
    args = parse_args()
    if args.seed is not None:
        random.seed(args.seed)
    if not args.lookup.exists():
        raise SystemExit(f"Lookup CSV not found: {args.lookup}")
    if not 0.0 <= args.alt_frequency <= 1.0:
        raise SystemExit("--alt-frequency must be between 0 and 1")

    rows = list(iter_lookup_rows(args.lookup))
    count = write_output(args.output, rows, args.alt_frequency)
    print(f"Wrote {count} synthetic rows to {args.output}")


if __name__ == "__main__":
    main()
